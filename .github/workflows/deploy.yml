name: Remote Deploy (Tencent TCR Managed)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 注意：这里不再需要 build 任务，也不需要 checkout 代码
    steps:
      - name: Wait and Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com --username 100020847423 --password-stdin
            
            # 1. 记录当前正在运行的镜像 ID (如果没有则为空)
            OLD_IMAGE_ID=$(docker images -q ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest)
            echo "Current Image ID: $OLD_IMAGE_ID"

            MAX_RETRIES=15  # 增加重试次数，Next.js 配合海外构建可能需要 3-7 分钟
            COUNT=0
            while [ $COUNT -lt $MAX_RETRIES ]; do
              # 强制拉取最新镜像
              docker pull ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest
              
              # 获取刚拉取到的镜像 ID
              NEW_IMAGE_ID=$(docker images -q ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest)
              
              # 对比：如果新旧 ID 不同，说明真正拉到了更新
              if [ "$NEW_IMAGE_ID" != "$OLD_IMAGE_ID" ]; then
                echo "Successfully pulled a NEW image! ID: $NEW_IMAGE_ID"
                break
              else
                COUNT=$((COUNT+1))
                echo "Pull result: Image ID hasn't changed yet. Waiting 30s... ($COUNT/$MAX_RETRIES)"
                sleep 30
              fi
            done
            
            # 2. 只有 ID 变了或者原本就没有镜像时才重启
            docker stop blog || true
            docker rm blog || true
            docker run -d --name blog -p 8081:8081 --restart unless-stopped ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest
            docker image prune -f