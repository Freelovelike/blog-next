name: Intelligent Remote Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  wait-for-tcr-build:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Image Digest Change
        run: |
          # 1. ç™»å½• TCR è·å–æŸ¥è¯¢æƒé™
          echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com --username 100020847423 --password-stdin
          
          IMAGE="ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest"
          
          # 2. è·å–å½“å‰çš„é•œåƒæŒ‡çº¹ (Digest)
          # æ³¨æ„ï¼šè¿™é‡ŒæŸ¥çš„æ˜¯äº‘ç«¯çš„æŒ‡çº¹
          INITIAL_DIGEST=$(docker manifest inspect $IMAGE -v | jq -r '.Descriptor.digest // .[0].Descriptor.digest')
          echo "Initial Digest: $INITIAL_DIGEST"
          
          # 3. å¾ªç¯æ£€æŸ¥ï¼Œç›´åˆ°æŒ‡çº¹å‘ç”Ÿå˜åŒ–
          echo "Watching for image update on Tencent Cloud..."
          MAX_RETRIES=20
          for i in $(seq 1 $MAX_RETRIES); do
            NEW_DIGEST=$(docker manifest inspect $IMAGE -v | jq -r '.Descriptor.digest // .[0].Descriptor.digest')
            
            if [ "$NEW_DIGEST" != "$INITIAL_DIGEST" ]; then
              echo "âœ… Detected new image! New Digest: $NEW_DIGEST"
              exit 0
            fi
            
            echo "ğŸ•’ No update yet (Attempt $i/$MAX_RETRIES). Waiting 30s..."
            sleep 30
          done
          
          echo "âŒ Timeout: Tencent Cloud build took too long."
          exit 1

  deploy:
    needs: wait-for-tcr-build
    runs-on: ubuntu-latest
    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com --username 100020847423 --password-stdin
            cd ~/app/blog
            docker pull ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest
            docker stop blog || true
            docker rm blog || true
            docker run -d --name blog -p 8081:8081 --restart unless-stopped ccr.ccs.tencentyun.com/my-project20010616/blog-next:latest
            docker image prune -f